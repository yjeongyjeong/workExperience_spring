<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="recruit">

	<resultMap type="com.spring.board.vo.RecruitVo" id="recruitVo">
		<result property="seq" column="SEQ" />
		<result property="name" column="NAME" />
		<result property="birth" column="BIRTH" />
		<result property="gender" column="GENDER" />
		<result property="phone" column="PHONE" />
		<result property="email" column="EMAIL" />
		<result property="addr" column="ADDR" />
		<result property="location" column="LOCATION" />
		<result property="workType" column="WORK_TYPE" />
		<result property="submit" column="SUBMIT" />
	</resultMap>

	<select id="recruitLoginCheck" parameterType="com.spring.board.vo.RecruitVo" resultMap="recruitVo">
		select * from recruit
		where
			name = #{name}
		and
			phone = #{phone}
	</select>
	
	
	<select id="selectLoginUserEducation" parameterType="com.spring.board.vo.RecruitVo"
	resultType="com.spring.board.vo.EducationVo">
		select e.*
		from education e
		left join recruit r on r.seq = e.seq
		where
		    r.name = #{name}
		and
		    r.phone = #{phone}
		order by e.start_period desc
	</select>
	
	<select id="selectLoginUserCareer" parameterType="com.spring.board.vo.RecruitVo"
	resultType="com.spring.board.vo.CareerVo">
		select c.*
		from career c
		left join recruit r on r.seq = c.seq
		where
		    r.name = #{name}
		and
		    r.phone = #{phone}
		order by c.start_period desc
	</select>
	
	<select id="selectLoginUserCertificate" parameterType="com.spring.board.vo.RecruitVo"
	resultType="com.spring.board.vo.CertificateVo">
		select cer.* 
		from certificate cer
		left join recruit r on r.seq = cer.seq
		where
			name = #{name}
		and
			phone = #{phone}
		order by cer.ACQU_DATE desc
	</select>
	
	
	<insert id="insertRecruit" parameterType="com.spring.board.vo.RecruitVo">
		insert into recruit(
			seq,
			name,
			birth,
			gender,
			phone,
			email,
			addr,
			location,
			work_Type,
			submit
		)
		values(
			( select NVL((select MAX(TO_NUMBER(seq)) + 1 from recruit), 1) as seq from dual ),
			#{name},
			#{birth},
			#{gender},
			#{phone},
			#{email},
			#{addr},
			#{location},
			#{workType},
			'N'
		)
	</insert>
	
	<insert id="insertEducation" parameterType="com.spring.board.vo.EducationVo">
	
	    <selectKey keyProperty="seq" resultType="int" order="BEFORE">
	  		  select seq from recruit where name = #{name} and phone = #{phone}
	    </selectKey>
    
		insert into education(
		    seq,
		    edu_seq,
		    school_name,
		    division,
		    start_period,
		    end_period,
		    major,
		    grade,
		    location)
	values(
	    	#{seq},
	     	(SELECT NVL(MAX(TO_NUMBER(edu_seq)) + 1, 1) AS EDU_SEQ FROM education WHERE seq = #{seq}),
		    #{school_name},
		    #{division},
		    #{start_period},
		    #{end_period},
		    #{major},
		    #{grade},
		    #{location}
	    )
	
	</insert>
	
	<insert id="insertCareer" parameterType="com.spring.board.vo.CareerVo">
	
	    <selectKey keyProperty="seq" resultType="int" order="BEFORE">
	  		  select seq from recruit where name = #{name} and phone = #{phone}
	    </selectKey>
    
		insert into career(
		    seq,
		    car_seq,
		    comp_name,
		    location,
		    start_period,
		    end_period,
		    task
		    )
	values(
	    	#{seq},
	     	(SELECT NVL(MAX(TO_NUMBER(car_seq)) + 1, 1) AS CAR_SEQ FROM career WHERE seq = #{seq}),
		    #{comp_name},
		    #{location},
		    #{start_period},
		    #{end_period},
		    #{task}
	    )
	</insert>
	
	<insert id="insertCertificate" parameterType="com.spring.board.vo.CertificateVo">
	
	    <selectKey keyProperty="seq" resultType="int" order="BEFORE">
	  		  select seq from recruit where name = #{name} and phone = #{phone}
	    </selectKey>
    
		insert into certificate(
		    seq,
		    cert_seq,
		    qualifi_name,
		    acqu_date,
		    organize_name
		    )
	values(
	    	#{seq},
	     	(SELECT NVL(MAX(TO_NUMBER(cert_seq)) + 1, 1) AS CERT_SEQ FROM certificate WHERE seq = #{seq}),
		    #{qualifi_name},
		    #{acqu_date},
		    #{organize_name}
	    )
	</insert>
				
	<delete id="deleteRecruit" parameterType="com.spring.board.vo.RecruitVo">
		delete from recruit
		where name = #{name} and phone = #{phone}
	</delete>
	
	<delete id="deleteEducation" parameterType="com.spring.board.vo.RecruitVo">
		delete from education 
		where seq = 
			(select seq from recruit where name = #{name} and phone = #{phone})
	</delete>
	
	<delete id="deleteCareer" parameterType="com.spring.board.vo.RecruitVo">
		delete from career
		where seq = 
			(select seq from recruit where name = #{name} and phone = #{phone})
	</delete>
	
	<delete id="deleteCertificate" parameterType="com.spring.board.vo.RecruitVo">
		delete from certificate
		where seq = 
			(select seq from recruit where name = #{name} and phone = #{phone})
	</delete>
	
	<select id="CalEduPeriod" parameterType="com.spring.board.vo.RecruitVo" resultType="Integer">
		SELECT TO_DATE(end_period, 'YYYY.MM') - TO_DATE(start_period, 'YYYY.MM') AS total_EduPeriod
		FROM education where education.seq = #{seq};
	</select>

	<select id="CalCarPeriod" parameterType="com.spring.board.vo.RecruitVo" resultType="Integer">
		SELECT TO_DATE(end_period, 'YYYY.MM') - TO_DATE(start_period, 'YYYY.MM') AS total_CarPeriod
		FROM career where career.seq = #{seq};
	</select>

	<update id="updateSubmit" parameterType="com.spring.board.vo.RecruitVo" >
		update recruit set submit = 'Y' where seq = #{seq}
	</update>
	
	
	
</mapper>